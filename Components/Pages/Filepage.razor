@page "/search/{category?}/{url?}"
@inject HttpClient Http
@inject ProfileService ProfileService

@if (!Loading)
{
    @if(FileFound)
    {        
        <PageTitle>@Lines[0]</PageTitle>
        
        <div id="container">
            <h1 class="title">@Lines[0]</h1>
            <p class="author"><i>@Lines[1]</i></p>
            <br>

            @for (int i = 3; i < Lines.Length; i++)
            {
                if(String.IsNullOrWhiteSpace(Lines[i]))
                {
                    <br>
                }else
                {
                    string[] words = Lines[i].Split(new char[] { ' ', '.', '?', ',', '-', '!', ';', ':', 'â€”', '"', '\''}, StringSplitOptions.RemoveEmptyEntries);
                    
                    <p>
                        @foreach (string word in words)
                        {      
                            <span class="highlightable @(ProfileService.HasTerm(word) ? "added" : "")"
                                @onclick="() => ProfileService.ToggleTerm(word)">
                                @word
                            </span>
                            
                            @if (!word.Equals(words.Last()))
                            {
                                <span>&nbsp;</span>
                            }
                        }
                    </p>
                }
            }
        </div>
    }else
    {
        <PageTitle>Missing</PageTitle>
        <p>File @URL not found.</p>
    }
}else
{
    <p></p>
}

@code
{
    [Parameter]
    public string? Category { get; set; }
    
    [Parameter]
    public string? URL { get; set; }

    string Text = "";
    string[] Lines = new string[0];

    bool FileFound = false;
    bool Loading = true;

    protected override async Task OnParametersSetAsync()
    {
        Loading = true;
        FileFound = false;

        if (URL == null)
        {
            FileFound = false;
        }
        else
        {
            HttpResponseMessage Message = await Http.GetAsync("data/" + Category + "/" + URL + ".txt");
            if (Message.IsSuccessStatusCode)
            {
                byte[] Data = await Message.Content.ReadAsByteArrayAsync();
                Text = Encoding.UTF8.GetString(Data);

                Lines = Text.Split(new string[] { "\n" }, StringSplitOptions.None);
                
                await ProfileService.UpdateRecent(Lines[0], Category, URL);

                FileFound = true;
            }else
            {
                FileFound = false;
            }
        }

        Loading = false;
    }
}