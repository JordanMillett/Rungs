@page "/songs/{url?}"
@inject HttpClient Http
@inject ProfileService ProfileService

@if (!Loading)
{
    @if(SongFound)
    {        
        <PageTitle>@Lines[0]</PageTitle>
        
        <div id="container">
            <h1 class="title">@Lines[0]</h1>
            <p class="artist"><i>@Lines[1]</i></p>
            <br>

            @for (int i = 3; i < Lines.Length; i++)
            {
                if(String.IsNullOrWhiteSpace(Lines[i]))
                {
                    <br>
                }else
                {
                    string[] words = Lines[i].Split(new char[] { ' ', '.', '?', ',', '-', '!', ';', ':', 'â€”', '"', '\''}, StringSplitOptions.RemoveEmptyEntries);
                    
                    <p>
                        @foreach (string word in words)
                        {      
                            <span class="highlightable @(ProfileService.HasTerm(word) ? "added" : "")"
                                @onclick="() => ProfileService.ToggleTerm(word)">
                                @word
                            </span>
                            
                            @if (!word.Equals(words.Last()))
                            {
                                <span>&nbsp;</span>
                            }
                        }
                    </p>
                }
            }
        </div>
    }else
    {
        <PageTitle>Missing</PageTitle>
        <p>Song @URL not found.</p>
        /*
        <p>View included songs below:</p>
        
        @if(SongListLoaded)
        {
            <ul>
            @for (int i = 0; i < AllSongs.Length; i++)
            {
                <li><a href="songs/@AllSongs[i].ToLower()">@AllSongs[i]</a></li>
            }
            </ul>
        }else
        {
            <p></p>
        }*/
    }
}else
{
    <p></p>
}

@code
{
    string[] AllSongs = new string[0];

    [Parameter]
    public string? URL { get; set; }

    string Text = "";
    string[] Lines = new string[0];

    bool SongFound = false;
    bool Loading = true;

    protected override async Task OnParametersSetAsync()
    {
        Loading = true;
        SongFound = false;

        if (URL == null)
        {
            SongFound = false;
        }
        else
        {
            HttpResponseMessage Message = await Http.GetAsync("data/songs/" + URL + ".txt");
            if (Message.IsSuccessStatusCode)
            {
                byte[] Data = await Message.Content.ReadAsByteArrayAsync();
                Text = Encoding.UTF8.GetString(Data);

                Lines = Text.Split(new string[] { "\n" }, StringSplitOptions.None);
                
                await ProfileService.UpdateRecent(Lines[0], URL);

                SongFound = true;
            }else
            {
                SongFound = false;
            }
        }

        Loading = false;
    }
}